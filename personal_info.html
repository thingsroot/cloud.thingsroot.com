<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<link href="css/bootstrap.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<link href="css/animate.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="js/layui/css/layui.css"  media="all">
		<title>个人信息</title>
	</head>
	<body>
	<!-- 头部 -->
	<!-- 顶部导航 start -->
	<nav class="nav_herder">
		<div class="nav_left gate_hand" onClick="location='index.html'"><img src="img/cloud_thingslink_logo.png" class="logo"/>冬笋物联网</div>
		<div class="pull-right nav_right">
			<p class="J_getMembers hd"><img src="img/top_management.png"/><span>成员管理</span></p><em>|</em>
			<p onclick="javascript:$('#messageBox').show()"><img src="img/top_news.png"/><span class="redDot"></span></p><em>|</em>
			<p onClick="location='personal_info.html'"><img src="img/top_avatar.png"/><span class="J_nickname">昵称</span></p><em>|</em>
			<p><img src="img/top_quit.png" id="J_logout"/></p>
		</div>
	</nav>
	<!-- 顶部导航 end -->
		<div class="down-main">
			<!-- 左导航 -->
			<div class="left-main left-full">
				<div class="sidebar-fold">个人中心</div>
				<div class="subNav bg-color" onClick="location='personal_info.html'">
					<img src="img/personal_info.png" class="hd_img"/>
					<img src="img/personal_info_hover.png" class="hover_img"/>
					<p class="sublist-title">个人信息</p>
				</div>
				<!--<div class="subNav" onClick="javascript:alt('开发中',4);">-->
					<!--<img src="img/personal_collect.png" class="hd_img"/>-->
					<!--<img src="img/personal_collect_hover.png" class="hover_img"/>-->
					<!--<p class="sublist-title">我的收藏</p>-->
				<!--</div>-->
				<!--<div class="subNav" onClick="location='platform_message.html'">-->
					<!--<img src="img/personal_news.png" class="hd_img"/>-->
					<!--<img src="img/personal_news_hover.png" class="hover_img"/>-->
					<!--<p class="sublist-title">消息中心</p>-->
				<!--</div>-->
				<div class="subNav J_getMembers">
					<img src="img/personal_member.png" class="hd_img"/>
					<img src="img/personal_member_hover.png" class="hover_img"/>
					<p class="sublist-title">成员管理</p>
				</div>
				<div class="subNav" onClick="location='set.html'">
					<img src="img/personal_setup.png" class="hd_img"/>
					<img src="img/personal_setup_hover.png" class="hover_img"/>
					<p class="sublist-title">设置</p>
				</div>
	  		</div>
			<!-- 个人信息内容 -->
	  		<div class="right-product my-index right-full">
	  			<div class="rightHeight">
			  		<ol class="breadcrumb">
					    <li><img src="img/icon_nav.png" />个人中心</li>
					    <li class="active">个人信息</li>
					</ol>
					<div class="main_content personal_main">
						<div class="top cf">
							<span class="fl">个人信息</span>
						</div>
						<div class="personal_content">
							<div class="info_main">
								<p>头像</p>
								<div class="icon js_uploadBox">
									<div class="js_showBox"></div>
									<button>编辑头像</button>
									<input type="file" class="js_upFile" >
								</div>
							</div>
							<div class="userinfo_main">
								<p><span>用户名</span><span style="font-size: 18px;font-weight: 600" id="user_name"></span></p>
								<p><span>邮&nbsp;&nbsp;&nbsp;箱</span><span id="user_email"></span></p>
								<p><span>电&nbsp;&nbsp;&nbsp;话</span><span id="user_phone"></span></p>
								<p><span>身&nbsp;&nbsp;&nbsp;份</span><span id="user_identity"></span></p>
							</div>
							<div class="edit_info">
								<button id="edit_userInfo">编辑</button>
								<button id="edit_userPassword">修改密码</button>
							</div>
						</div>
					</div>
	  			</div>
				<div class="copyright">SymTech Application © 2008-2017</div>
	  		</div>
			<!-- 编辑弹框 -->
			<div id="edit_userInfoBox" style="display: none;">
				<div>
					<div class="title">编辑资料 <span class="close_editUserInfo">×</span></div>
					<div class="info_main">
						<p>姓</p>
						<input type="text" value="" name="first_name" />
					</div>
					<div class="info_main">
						<p>名</p>
						<input type="text" value="" name="last_name" />
					</div>
					<div class="info_main">
						<p>邮&nbsp;&nbsp;箱</p>
						<input type="text" value="" name="email" />
					</div>
					<div class="info_main">
						<p>电&nbsp;&nbsp;话</p>
						<input type="text" value="" name="phone" />
					</div>
					<button class="J_updateUser">保存</button>
				</div>
			</div>

			<!-- 修改密码弹框 -->
			<div id="edit_userPasswordBox" style="display: none;">
				<div>
					<div class="title">修改密码 <span class="close_editUserPassword">×</span></div>
					<div class="info_main">
						<p>请输入旧密码</p>
						<input type="password" value="" name="old_password" />
					</div>
					<div class="info_main">
						<p>请输入新密码</p>
						<input type="password" value="" name="new_password" />
					</div>
					<div class="info_main">
						<p>请再次输入新密码</p>
						<input type="password" value="" name="new_passwords" />
					</div>
					<button class="J_updateUserPassword">保存</button>
				</div>
			</div>
	  	</div>

	<!--消息弹框-->
	<div id="messageBox">
		<p id="messageBox_title">最新消息
			<span class="messageBox_close" onClick="javascript:$('#messageBox').hide();">×</span>
		</p>
		<div>
			<p>通信设备</p>
			<ul class="list_box">
				<!--<li class="box_li">-->
				<!--<span class="message_name"></span>-->
				<!--<span style="display: none;" class="message_id"></span>-->
				<!--<span style="float: right;" class="message_ago"></span>-->
				<!--</li>-->
				<!--<li class="box_li">-->
				<!--<span class="message_name"></span>-->
				<!--<span style="display: none;" class="message_id"></span>-->
				<!--<span style="float: right;" class="message_ago"></span>-->
				<!--</li>-->
			</ul>
		</div>
		<p class="GoCenter" onClick="location='platform_message.html'">进入消息中心</p>
	</div>
	<!--消息弹框 end-->
	  	
	<script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
	<script src="js/jquery.timeago.js"></script>
	<script src="js/transport.js" type="text/javascript"></script>
	<script src="js/jQuery.cookie.js" type="text/javascript"></script>	
	<script src="js/layui/layui.js" charset="utf-8"></script>
	<script src="js/bootstrap.min.js" type="text/javascript"></script>
	<script src="js/arrayFun.js" type="text/javascript"></script>
	<script src="js/common.js" type="text/javascript"></script>
	<script src="js/user.js" type="text/javascript"></script>		
	<script src="js/jquery.uploadView.js" type="text/javascript"></script>
	<script src="js/message.js"></script>
	<script src="js/index.js" type="text/javascript"></script>
	<script>
		$(function(){
            //计时器
            var timer;
            //获取用户信息
            var usr = getCookie('usr');
            Ajax.call('/api/resource/User/'+usr,'', displayUserFun, 'GET', 'JSON', 'FORM');
            function displayUserFun(req) {
                console.log(req)
                var name = req.data.first_name+req.data.last_name;
            	$("#user_name").html(name);
            	$("#user_email").html(req.data.email);
            	$("#user_phone").html(req.data.phone);
            	// $(".userinfo_main>#user_identity").val(req.data.identity);
            	console.log(req);
            }
//			上传头像
			$(".js_upFile").uploadView({
				uploadBox: '.js_uploadBox',//设置上传框容器
				showBox : '.js_showBox',//设置显示预览图片的容器
				allowType: ["gif", "jpeg", "jpg", "bmp", "png"], //允许上传图片的类型
				maxSize :2, //允许上传图片的最大尺寸，单位M
				success:function(e){
					var imagesrc = $(".js_showBox img").attr("src").split(',');
		            var image_base64 = imagesrc[1];
		            var api_key = "98lLFi5YCWsBxBFD3OSx5rTeVR6OmL80";
		            var api_secret = "4_NPTWfkEkl_ao215Vqqx3d5GLHexG2a";
		            $.ajax({
		                url: "https://api-cn.faceplusplus.com/cardpp/v1/ocridcard",
		                type: "POST",
		                dataType: "json",
		                enctype: 'multipart/form-data',
		                data: {api_key:api_key,api_secret:api_secret,image_base64:image_base64},
		                success:function(data){
		                    $.each(data.cards,function(i,item){
		                          $('input[name=linkman]').val(item.name);
		                          $('input[name=sfcode]').val(item.id_card_number);
		                    })
		                }
		            });
				}
			});

			//点击编辑按钮
			$('#edit_userInfo').click(function(){
			    $('#edit_userInfoBox').show();
			    //用户信息回显
                var usr = getCookie('usr');
                Ajax.call('/api/resource/User/'+usr,'', displayUserFun, 'GET', 'JSON', 'FORM');
                function displayUserFun(req) {
                    $("input[name=first_name]").val(req.data.first_name);
                    $("input[name=last_name]").val(req.data.last_name);
                    $("input[name=email]").val(req.data.email);
                    $("input[name=phone]").val(req.data.mobile_no);
                    console.log(req);
                }
			});

            // 修改个人信息 --- 保存
            $('.J_updateUser').click(function(){
                var userInfo = {
                    "first_name":$("input[name=first_name]").val(),
                    "last_name":$("input[name=last_name]").val(),
                    "email":$("input[name=email]").val(),
                    "phone":$("input[name=phone]").val()
                };
                Ajax.call('/api/resource/User/'+usr,JSON.stringify(userInfo), update_userinfoFun, 'PUT', 'JSON', 'JSON');
                function update_userinfoFun(req) {
                    console.log(req);
                    alt('保存成功',1);
                    $('#edit_userInfoBox').hide();
                    setTimeout(function () {
                        location.reload();
                    },3000);
                }
            });

			//关闭修改弹框
			$('.close_editUserInfo').click(function(){
                $('#edit_userInfoBox').hide();
			});

			//点击修改密码
			$('#edit_userPassword').click(function () {
                $('#edit_userPasswordBox').show();
                $("input[name=old_password]").val('');
                $("input[name=new_password]").val('');
                $("input[name=new_passwords]").val('');
            });

			//点击保存===修改密码
			$('.J_updateUserPassword').click(function () {
			    var new0 = $("input[name=old_password]").val();
			    var new1 = $("input[name=new_password]").val();
			    var new2 =  $("input[name=new_passwords]").val();
			    if(new0 == ''){
			        alt('请输入旧密码',1);
				}else if(new1 == ''){
                    alt('请输入新密码',1);
                }else if(new2 == ''){
                    alt('请再次输入新密码',1);
                }else if( new0!=''&&new1!=''&&new2!=''&&new0 == new1 ){
			        alt('新密码不能与旧密码一致',1);
				}else if( new0!=''&&new1!=''&&new2!=''&&new1 == new2 ){
                    //修改密码请求接口
                    var password = {
                        "old_password":$("input[name=old_password]").val(),
                        "new_password":$("input[name=new_password]").val()
                    };
                    $.ajax({
						url:'/api/method/frappe.core.doctype.user.user.update_password',
						type:'POST',
						data:JSON.stringify(password),
						dataType:'JSON',
						success:function (req) {
                            alt('修改成功',1);
                            $('#edit_userPasswordBox').hide();
                            var full_name = req.full_name;
                            console.log(full_name);
                            // delCookie('DS_'+full_name,null);  //清楚cookie缓存
                            // delCookie(full_name,null);
                            setTimeout(function () {
                                window.open("login.html","_self");
                            },1000);
                        },
						error:function () {
							alt('旧密码错误',2);
                            $("input[name=old_password]").val('');
                            $("input[name=new_password]").val('');
                            $("input[name=new_passwords]").val('');
                        }
					})
				}else if(new1 != new2){
				    alt('请确认新密码输入一致',1);
				}
            });

			//关闭修改密码弹框
			$('.close_editUserPassword').click(function () {
                $('#edit_userPasswordBox').hide();
            })
		})
	</script>
	</body>
</html>

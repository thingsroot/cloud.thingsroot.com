<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="/img/favicon.ico" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/viccom.css" rel="stylesheet" />
    <link href="css/animate.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="js/layui/css/layui.css"  media="all">
    <!-- 加载script start -->
    <script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="js/jquery.timeago.js"></script>
    <script src="js/transport.js" type="text/javascript"></script>
    <script src="js/jQuery.cookie.js" type="text/javascript"></script>
    <script src="js/layui/layui.js" charset="utf-8"></script>
    <script src="js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/arrayFun.js" type="text/javascript"></script>
    <script src="js/common.js" type="text/javascript"></script>
    <script src="js/user.js" type="text/javascript"></script>
    <script src="js/index.js" type="text/javascript"></script>

    <!--markdown   css-->
    <link rel="stylesheet" href="js/editor.md-master/css/editormd.min.css" />
    <script src="js/editor.md-master/editormd.min.js"></script>
    <!--markdown   js -->
    <title>修改应用详情</title>
</head>
<body>

<!-- 顶部导航 start -->
<nav class="nav_herder">
    <div class="nav_left gate_hand" onClick="location='index.html'"><img src="img/cloud_thingslink_logo.png" class="logo"/>冬笋物联网</div>
    <div class="pull-right nav_right">
        <p class="J_getMembers hd"><img src="img/top_management.png"/><span>成员管理</span></p><em>|</em>
        <p onclick="javascript:$('#messageBox').show()" style="position: relative;"><img src="img/top_news.png"/><span style="display:none" class="redDot"></span></p><em>|</em>
        <p onClick="location='personal_info.html'"><img src="img/top_avatar.png"/><span class="J_nickname">昵称</span></p><em>|</em>
        <p><img src="img/top_quit.png" id="J_logout"/></p>
    </div>
</nav>
<!-- 顶部导航 end -->

<div class="down-main">
    <!-- 左侧导航 start -->
    <div class="left-main left-full">
        <div class="sidebar-fold"><img src="img/nav_shrink.png"/></div>
        <div class="subNav" onClick="location='index.html'">
            <img src="img/nav_home.png" class="hd_img"/>
            <img src="img/nav_home_hover.png" class="hover_img"/>
            <p class="sublist-title">首页</p>
        </div>
        <div class="subNav" onClick="location='mine.html'">
            <img src="img/nav_equipment.png" class="hd_img"/>
            <img src="img/nav_equipment_hover.png" class="hover_img"/>
            <p class="sublist-title">我的网关</p>
        </div>
        <div class="subNav" onClick="location='application_list.html'">
            <img src="img/my_app.png" class="hd_img"/>
            <img src="img/my_apps.png" class="hover_img"/>
            <p class="sublist-title">我的应用</p>
        </div>
        <div class="subNav" onClick="location='template.html'">
            <img src="img/my_app.png" class="hd_img"/>
            <img src="img/my_apps.png" class="hover_img"/>
            <p class="sublist-title">我的模板</p>
        </div>
    </div>
    <!-- 左侧导航 start -->
    <div class="right-product my-index right-full">
        <!-- 标题 -->
        <div class="details_title"><span class="version_name">修改应用详情</span></div>
        <!-- 表单 -->
        <div class="app_edit_form">
            <img src="img/app.jpg" alt="">
            <div>
                <div>
                    <span>应用名称 <i>*</i></span>
                    <input type="text" id="app_name" class="form-control boot_input" placeholder="应用名称" aria-describedby="basic-addon2">
                    <span>授权类型 <i>*</i></span>
                    <div class="btn-group search_filter4" role="group">
                        <button type="button" class="select_width btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="search_keyword4 select_text" data-search_keyword="1">免费</span>
                            <span class="caret select_arrow"></span>
                        </button>
                        <ul class="dropdown-menu select_menu over"  >
                            <li data-name=""><a style="cursor:pointer">免费</a></li>
                        </ul>
                    </div>
                    <span>应用厂商 <i>*</i></span>
                    <div class="btn-group search_filter2" role="group">
                        <button type="button" class="select_width btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="search_keyword2 select_text" data-search_keyword="1">应用厂商</span>
                            <span class="caret select_arrow"></span>
                        </button>
                        <ul class="dropdown-menu select_menu over" id="changshang">
                            <!--<li data-name=""><a style="cursor:pointer">1</a></li>-->
                        </ul>
                    </div>
                </div>
                <div>
                    <span>设备型号 <i>*</i></span>
                    <input type="text" id="shebeihao" class="form-control boot_input" placeholder="设备型号" aria-describedby="basic-addon2">
                    <span>协议 <i>*</i></span>
                    <div class="btn-group search_filter3" role="group">
                        <button type="button" class="select_width btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="search_keyword3 select_text" data-search_keyword="1">协议</span>
                            <span class="caret select_arrow"></span>
                        </button>
                        <ul class="dropdown-menu select_menu  over" id="shouquan">
                            <!--<li data-name=""><a style="cursor:pointer">1</a></li>-->
                        </ul>
                    </div>
                    <span>类别 <i>*</i></span>
                    <div class="btn-group search_filter1" role="group">
                        <button type="button" class="select_width btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="search_keyword1 select_text" data-search_keyword="1">类别</span>
                            <span class="caret select_arrow"></span>
                        </button>
                        <ul class="dropdown-menu select_menu  over" id="leibie">
                            <!--<li data-name=""><a style="cursor:pointer">2</a></li>-->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!--markdown 编辑器-->
        <div class="myMarkdown">
            <p>描述</p>
            <div class="editormd" id="test-editormd">
                <textarea class="editormd-markdown-textarea" name="test-editormd-markdown-doc"></textarea>
                <!-- 第二个隐藏文本域，用来构造生成的HTML代码，方便表单POST提交，这里的name可以任意取，后台接受时以这个name键为准 -->
                <textarea class="editormd-html-textarea" name="text"></textarea>
            </div>
            <p><button class="app_edit_submit">提交</button><button class="app_add">创建</button></p>
        </div>

        <p class="copyright">SymTech Application © 2008-2017</p>
    </div>
    <!--消息弹框-->
    <div id="messageBox">
        <p id="messageBox_title">最新消息
            <span class="messageBox_close" onClick="javascript:$('#messageBox').hide();">×</span>
        </p>
        <div>
            <p class="have">通信设备</p>
            <p class="no_have" style="line-height: 100px;text-align: center;font-size: 18px">暂时没有最新信息</p>
            <ul class="list_box">
                <!--<li class="box_li">-->
                <!--<span class="message_name"></span>-->
                <!--<span style="display: none;" class="message_id"></span>-->
                <!--<span style="float: right;" class="message_ago"></span>-->
                <!--</li>-->
            </ul>
        </div>
        <p class="GoCenter" onClick="location='platform_message.html'">进入消息中心</p>
    </div>
    <!--消息弹框 end-->
</div>

<script>
    $(function() {
        $('.J_nickname').text(getCookie('full_name'));

        if(window.location.href.split("=")[1] == 1){
            document.title = "创建新应用";
            $('.version_name').text('创建新应用');
            $('.app_add').show();
            $('.app_edit_submit').hide();
        }else{
            document.title = "修改应用详情";
            $('.version_name').text('修改应用详情');
            $('.app_add').hide();
            $('.app_edit_submit').show();
            //获取应用详情信息
            var appId = {'app':decodeURI(window.location.href.split("=")[1])};
            $.ajax({
                url: "/apis/api/method/app_center.api.app_detail",
                type: "GET",
                data: appId,
                success: function (data) {
                    console.log(data.message);
                    var datas = data.message;
                    $('#app_name').val(datas.app_name);   //应用名称
                    $('#shebeihao').val(datas.device_serial);   //设备型号
                    $('.search_keyword2').text(datas.device_supplier);   //设备厂商
                    $('.search_keyword3').text(datas.protocol);   //协议
                    $('.search_keyword1').text(datas.category);   //应用分类
                    if(datas.category == 'Open'){
                        $('.search_keyword4').text("免费");   //授权类型  ---免费
                    }
                    $('#test-editormd>textarea').text(datas.description)   //markdown
                },
                error: function () {
                    console.log('no');
                }
            });
        }

        editormd("test-editormd", {
            width : "96%",
            height : 520,
            syncScrolling : "single",
            //你的lib目录的路径，
            path    : "js/editor.md-master/lib/",
            //这个配置在simple.html中并没有，但是为了能够提交表单，使用这个配置可以让构造出来的HTML代码直接在第二个隐藏的textarea域中，方便post提交表单。
            saveHTMLToTextarea : true,
            imageUpload : true,
            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL : "/upload/image"
        });

        var token = $.cookie('DS_auth_token');
        $.ajaxSetup({
            headers: { // 默认添加请求头
                "X-Frappe-CSRF-Token": token
            }
        });





        //获取设备厂商
        var data1 = {'name':'冬笋科技'};
        $.ajax({
            url: "/apis/api/method/app_center.api.app_suppliers",
            type: "GET",
            data: data1,
            success: function (req) {
                var data = req.message;
                for(var i=0;i<data.length;i++){
                    // console.log(data[i]);
                    $('#changshang').append(
                        '<li data-name=""><a style="cursor:pointer">'+ data[i].name +'</a></li>'
                    )
                }
            },
            error: function () {
                console.log('error');
            },
            complete: function () {
                $('.search_filter2 li').on('click', function() {
                    $('.search_keyword2').text($(this).text());
                });
            }
        });

        //获取协议
        var data2 = {'name':'Redis'};
        $.ajax({
            url: "/apis/api/method/app_center.api.app_protocols",
            type: "GET",
            data: data2,
            success: function (req) {
                // console.log(req);
                var data = req.message;
                for(var i=0;i<data.length;i++){
                    $('#shouquan').append(
                        '<li data-name=""><a style="cursor:pointer">'+ data[i].name +'</a></li>'
                    )
                }
            },
            error: function () {
                console.log('error')
            },
            complete: function () {
                $('.search_filter3 li').on('click', function() {
                    $('.search_keyword3').text($(this).text());
                });
            }
        });

        //获取应用分类
        var name = {'name':'General'};
        $.ajax({
            url:"/apis/api/method/app_center.api.app_categories",
            type:"GET",
            data: name,
            success: function(req){
                var data = req.message;
                for(var i=0;i<data.length;i++){
                    $('#leibie').append(
                        '<li data-name=""><a style="cursor:pointer">'+ data[i].name +'</a></li>'
                    )
                }
            },
            error: function () {
                console.log('error')
            },
            complete: function () {
                $('.search_filter1 li').on('click', function() {
                    $('.search_keyword1').text($(this).text());
                });
            }
        })


        //提交修改
        $('.app_edit_submit').click(function () {
            var datas = {
                app            : decodeURI(window.location.href.split("=")[1]),
                app_name       : $('#app_name').val(),
                category       : $('.search_keyword1').text(),
                device_supplier: $('.search_keyword2').text(),
                device_serial  : $('#shebeihao').val(),
                description    :$('#test-editormd>textarea').text()
            };
            console.log(datas);
            if(datas.app!=''&&datas.app_name!=''&&datas.category!=''&&datas.device_supplier!=''&&datas.device_serial!=''&&datas.description!=''){
                $.ajax({
                    url: "/apis/api/method/app_center.appmgr.modify",
                    type: "POST",
                    data: JSON.stringify(datas),
                    contentType:'application/json',
                    success:function (req) {
                        console.log(req);
                        alt('修改成功',1);
                    },
                    error: function () {
                        alt('修改失败',3);
                    }
                })
            }else{
                alt('修改信息不能为空',2);
            }
        });

        //创建新应用
        $('.app_add').click(function () {
            var datas = {
                app_name       : $('#app_name').val(),
                category       : $('.search_keyword1').text(),
                license_type   : 'Open',
                device_supplier: $('.search_keyword2').text(),
                protocol       : $('.search_keyword3').text(),  //协议
                device_serial  : $('#shebeihao').val(),
                description    :$('#test-editormd>textarea').val()
            };
            console.log(datas);
            if(datas.app!=''&&datas.app_name!=''&&datas.category!=''&&datas.device_supplier!=''&&datas.device_serial!=''&&datas.description!=''){
                $.ajax({
                    url: "/apis/api/method/app_center.appmgr.new",
                    type: "POST",
                    data: JSON.stringify(datas),
                    contentType:'application/json',
                    success:function (req) {
                        $('#app_name').val("");
                        $('.search_keyword1').text("类别");
                        $('.search_keyword2').text("应用厂商");
                        $('.search_keyword3').text("协议");
                        $('.search_keyword4').text("免费");
                        $('#shebeihao').val("");
                        $('#test-editormd>textarea').val("");
                        alt('创建成功',1);
                        setTimeout(function () {
                            window.location = "application_list.html";
                        },1000)
                    },
                    error: function () {
                        alt('创建失败',3);
                    }
                })
            }else{
                alt('修改信息不能为空',2);
            }
        })

    });

    //message
    var datas = {
        "start": 0,
        "limit": 12
    };
    Ajax.call('/apis/api/method/iot.user_api.device_activity',JSON.stringify(datas), message, 'POST', 'JSON', 'JSON');
    function message(req){
        console.log(req.message)
        var list = req.message;
        var posed = [];
        for (var j=0;j<list.length;j++){
            console.log(list[j].disposed);
            if(list[j].disposed == 0){
                posed.push(list[j]);
            }
        }  //把所有未读消息集合
        // console.log(posed);
        if(posed.length == 0){
            console.log('暂时没有未读信息');
            $('.have').hide();
            $('.no_have').show();
            $('.redDot').hide();
        }else{
            console.log('有未读信息');
            $('.have').show();
            $('.no_have').hide();
            $('.redDot').show();
            //渲染列表
            for (var i=0;i<12;i++){
                $('.list_box').append(
                    '<li class="box_li">' +
                    '<span>'+posed[i].subject.substr(0,18)+'...'+ $.parseJSON(posed[i].message).device_status +'!</span>' +
                    '<span class="message_id" style="display: none;">'+posed[i].name+'</span>' +
                    '<span class="message_ago" title="'+posed[i].creation+'"></span>' +
                    '</li>'
                );
                $('.message_ago').eq(i).timeago();
                $('.box_li')[i].index = i;
                $('.box_li')[i].onclick = function(){
                    var name = $('.message_id').eq(this.index).text();
                    location.href = 'platform_details.html?name=' + name;
                }
            }
            var ago = $('.message_ago');
            console.log(ago);
            for(var i=0;i<ago.length;i++){
                console.log(ago[i])
            }
            $('.message_ago').eq(i).timeago();
        }
    }
</script>

</body>
</html>
